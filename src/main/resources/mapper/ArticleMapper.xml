<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.wolfhouse.wolfhouseblog.mapper.ArticleMapper">

    <resultMap id="articleInsert" type="com.wolfhouse.wolfhouseblog.pojo.domain.Article" autoMapping="true">
        <id column="id" property="id"/>
        <result column="title" property="title"/>
        <result property="authorId" column="author_id"/>
        <result property="content" column="content"/>
        <result property="visibility" column="visibility"/>
        <result property="tags" column="tags" typeHandler="com.mybatisflex.core.handler.JacksonTypeHandler"/>
        <result property="comUseTags" column="com_use_tags"
                typeHandler="com.mybatisflex.core.handler.JacksonTypeHandler"/>
    </resultMap>
    <insert id="insertWithPkBack" useGeneratedKeys="true" keyProperty="id">
        insert into article(title, `primary`, author_id, content, visibility, partition_id, tags, com_use_tags)
        values (#{title},
                #{primary},
                #{authorId},
                #{content},
                #{visibility},
                #{partitionId},
                #{tags,typeHandler=com.mybatisflex.core.handler.JacksonTypeHandler},
                #{comUseTags,typeHandler=com.mybatisflex.core.handler.JacksonTypeHandler})
    </insert>

    <update id="removeTags">
        update article
        set com_use_tags = (
        select JSON_ARRAYAGG(tag)
        from JSON_TABLE(com_use_tags, '$[*]' COLUMNS (tag VARCHAR(255) PATH '$')) as jt
        where 1 = 1
        <if test="tagIds != null and !tagIds.isEmpty()">
            and jt.tag not in
            <foreach collection="tagIds" item="id" separator="," open="(" close=")">
                #{id}
            </foreach>
        </if>
        )
        where author_id = #{userId};
    </update>
</mapper>
